---
type: "always_apply"
---

# Telegraph-Image 项目开发规范

## 项目概述
Telegraph-Image 是一个基于 Cloudflare Pages 和 Telegram Bot API 的免费图床解决方案，采用无服务器架构，提供无限图片存储、全球 CDN 加速、智能内容审查等功能。

## 技术栈规范

### 前端技术栈
- 使用 **Vue.js 3.x** 作为主要前端框架，采用 Composition API 进行组件开发
- 使用 **Element Plus** 作为 UI 组件库，保持现有的视觉风格和用户体验
- 使用 **Vite** 作为现代构建工具，提供快速的开发体验和优化的生产构建
- 使用 ES6+ 模块系统和现代 JavaScript 特性
- 保持响应式设计，确保在移动设备上的良好体验

### 后端技术栈
- 使用 **Cloudflare Pages Functions** 作为无服务器运行环境
- 遵循 **Web Standards API** 规范，使用标准的 Web API
- 使用 **ES Modules** 模块系统，避免 CommonJS
- 核心依赖仅限于：`@cloudflare/pages-plugin-sentry` 和 `@sentry/tracing`

### 存储和外部服务
- **Telegram Bot API** 作为主要文件存储后端，不要更改存储方案
- **Cloudflare KV** 用于元数据存储，保持全球分布式特性
- **ModerateContent API** 用于内容审查，保持可选配置
- **Sentry** 用于错误监控和性能追踪

## 架构设计原则

### 无服务器架构
- 保持无状态设计，确保函数可以独立扩展
- 避免在函数中存储持久状态，使用 Cloudflare KV 存储数据
- 优化冷启动时间，避免大量依赖和复杂初始化
- 实现优雅的错误处理和降级策略

### 微服务设计
- 保持功能模块的独立性：上传服务、文件服务、管理服务
- 每个 Pages Function 应该职责单一，避免功能耦合
- 使用中间件模式处理通用逻辑（认证、监控、错误处理）
- API 设计遵循 RESTful 原则

### 性能优化
- 实施多层缓存策略：浏览器缓存 → CDN 缓存 → KV 存储
- 静态资源使用长期缓存（1年），动态内容使用短期缓存
- 优化图片处理和传输，支持 WebP 格式
- 实现并发处理优化，避免阻塞操作

## 代码规范

### JavaScript 编码规范
- 使用 ES6+ 语法，包括 async/await、箭头函数、解构赋值
- 函数命名使用动词开头，变量命名使用名词
- 使用 camelCase 命名约定，常量使用 UPPER_SNAKE_CASE
- 添加必要的 JSDoc 注释，特别是公共 API 函数

### Vue 3 开发规范
- 优先使用 **Composition API** 进行组件开发，避免 Options API
- 使用 `ref()` 和 `reactive()` 管理响应式数据
- 组件内使用 `setup()` 函数组织逻辑，返回模板需要的数据和方法
- 生命周期钩子使用 `onMounted()`、`onUnmounted()` 等组合式 API
- 使用 `computed()` 创建计算属性，`watch()` 监听数据变化
- Element Plus 组件使用全局注册方式，通过 `app.use(ElementPlus)` 引入
- 保持向后兼容，确保现有功能在升级后正常工作

### 文件组织规范
- Functions 文件放在 `functions/` 目录下，按功能模块组织
- 静态资源（HTML、CSS、JS）放在根目录
- 工具函数放在 `functions/utils/` 目录下
- 测试文件放在 `test/` 目录下，使用 `.test.js` 后缀

### 错误处理规范
- 所有 async 函数必须包含 try-catch 错误处理
- 使用结构化错误响应，包含错误码和描述信息
- 集成 Sentry 进行错误追踪，但要考虑隐私保护
- 实现优雅降级，避免单点故障影响整体服务

## 安全规范

### 认证和授权
- 管理接口使用 Basic Authentication 保护
- 支持 IP 白名单和地理位置限制
- 实现访问频率限制，防止滥用
- 敏感配置使用环境变量，不要硬编码

### 内容安全
- 集成内容审查 API，自动检测不当内容
- 实现文件类型和大小限制
- 使用 CSP（内容安全策略）防止 XSS 攻击
- 启用 HTTPS 强制重定向和 HSTS

### 数据保护
- 不存储用户个人信息，保持匿名性
- 文件元数据最小化存储，只保留必要信息
- 实现数据加密传输，使用 TLS 1.3
- 定期清理过期数据和日志

## 部署和运维规范

### 环境配置
- 使用环境变量管理配置，支持多环境部署
- 必需环境变量：`TG_Bot_Token`、`TG_Chat_ID`
- 可选环境变量：`ModerateContentApiKey`、`BASIC_USER`、`BASIC_PASS`
- 配置变更后必须重新部署才能生效

### 监控和日志
- 集成 Sentry 进行应用监控和错误追踪
- 使用结构化日志格式，包含时间戳和请求 ID
- 监控关键指标：响应时间、错误率、上传成功率
- 设置告警规则，及时发现和处理问题

### 版本管理
- 使用 Git 进行版本控制，遵循 GitFlow 工作流
- 提交信息遵循 Conventional Commits 规范
- 使用语义化版本号（Semantic Versioning）
- 自动化 CI/CD 流程，支持自动部署和回滚

## 开发流程规范

### 本地开发
- 使用 `wrangler pages dev` 启动本地开发服务器
- 配置本地环境变量文件 `.dev.vars`
- 运行测试用例确保功能正常：`npm test`
- 使用 `concurrently` 同时运行多个开发任务

### 代码提交
- 创建功能分支进行开发，避免直接在 main 分支提交
- 提交前运行代码检查和测试
- 提交信息格式：`<type>(<scope>): <subject>`
- 类型包括：feat、fix、docs、style、refactor、test、chore

### 代码审查
- 所有代码变更必须通过 Pull Request
- 确保代码通过自动化测试和检查
- 审查重点：功能正确性、性能影响、安全性、兼容性
- 及时响应审查意见，积极讨论技术方案

## 文档规范

### 文档结构
- 使用中文编写文档，符合中文用户习惯
- 按用户角色组织文档：用户手册、管理员手册、开发者指南
- 提供完整的 API 文档和使用示例
- 包含故障排除和常见问题解答

### 文档维护
- 代码变更时同步更新相关文档
- 使用 Markdown 格式编写文档
- 添加 Mermaid 图表说明复杂的架构和流程
- 定期审查和更新文档内容

## 测试规范

### 测试策略
- 使用 Mocha 作为测试框架
- 编写单元测试覆盖核心业务逻辑
- 实现集成测试验证 API 接口
- 测试覆盖率目标：80% 以上

### 测试实践
- 新功能开发必须包含相应的测试用例
- 测试用例应该覆盖正常流程和异常情况
- 使用模拟（Mock）技术隔离外部依赖
- 定期运行测试确保代码质量

## 性能优化指导

### 前端优化
- 实现代码分割和懒加载
- 压缩和合并静态资源
- 使用 CDN 加速资源加载
- 优化图片格式和大小

### 后端优化
- 优化函数执行时间，减少冷启动
- 实现连接复用和对象池
- 使用批量操作减少 API 调用
- 监控和优化内存使用

### 缓存优化
- 合理设置缓存策略和过期时间
- 使用 ETags 和条件请求
- 实现缓存预热和失效机制
- 监控缓存命中率和效果
