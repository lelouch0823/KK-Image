<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegraph-Image | ç»Ÿè®¡åˆ†æ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .stats-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0;
      color: #2c3e50;
      font-size: 28px;
      font-weight: 600;
    }

    .nav-links {
      margin-top: 16px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .nav-link {
      padding: 8px 16px;
      background: #409eff;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      background: #337ecc;
      transform: translateY(-2px);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .stat-card h3 {
      margin: 0 0 16px 0;
      color: #2c3e50;
      font-size: 18px;
      font-weight: 600;
    }

    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }

    .overview-item {
      text-align: center;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      color: white;
    }

    .overview-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .overview-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 16px;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: #666;
    }

    .error {
      color: #f56565;
      text-align: center;
      padding: 20px;
    }

    .recent-files {
      max-height: 300px;
      overflow-y: auto;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .file-meta {
      font-size: 12px;
      color: #666;
    }

    .refresh-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #409eff;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(64, 158, 255, 0.3);
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      background: #337ecc;
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .stats-container {
        padding: 16px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .overview-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="stats-container">
      <!-- å¤´éƒ¨ -->
      <div class="header">
        <h1>ğŸ“Š ç»Ÿè®¡åˆ†æä»ªè¡¨æ¿</h1>
        <div class="nav-links">
          <a href="/admin" class="nav-link">ğŸ“‹ æ–‡ä»¶ç®¡ç†</a>
          <a href="/admin-imgtc-vue3.html" class="nav-link">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</a>
          <a href="/upload.html" class="nav-link">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</a>
          <a href="/" class="nav-link">ğŸ  é¦–é¡µ</a>
        </div>
      </div>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="loading" class="loading">
        <el-icon class="is-loading" style="font-size: 24px;">
          <Loading />
        </el-icon>
        <span style="margin-left: 12px;">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</span>
      </div>

      <!-- é”™è¯¯çŠ¶æ€ -->
      <div v-if="error" class="error">
        <p>{{ error }}</p>
        <el-button @click="loadStats" type="primary">é‡è¯•</el-button>
      </div>

      <!-- ç»Ÿè®¡å†…å®¹ -->
      <div v-if="!loading && !error && stats" class="stats-grid">
        <!-- æ¦‚è§ˆç»Ÿè®¡ -->
        <div class="stat-card">
          <h3>ğŸ“ˆ æ€»è§ˆç»Ÿè®¡</h3>
          <div class="overview-stats">
            <div class="overview-item">
              <div class="overview-number">{{ formatNumber(stats.overview.totalFiles) }}</div>
              <div class="overview-label">æ€»æ–‡ä»¶æ•°</div>
            </div>
            <div class="overview-item">
              <div class="overview-number">{{ formatNumber(stats.overview.todayUploads) }}</div>
              <div class="overview-label">ä»Šæ—¥ä¸Šä¼ </div>
            </div>
            <div class="overview-item">
              <div class="overview-number">{{ formatNumber(stats.overview.weekUploads) }}</div>
              <div class="overview-label">æœ¬å‘¨ä¸Šä¼ </div>
            </div>
            <div class="overview-item">
              <div class="overview-number">{{ formatSize(stats.overview.totalSize) }}</div>
              <div class="overview-label">æ€»å­˜å‚¨</div>
            </div>
          </div>
        </div>

        <!-- ä¸Šä¼ è¶‹åŠ¿ -->
        <div class="stat-card" style="grid-column: span 2;">
          <h3>ğŸ“Š ä¸Šä¼ è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰</h3>
          <div class="chart-container">
            <canvas ref="trendChart"></canvas>
          </div>
        </div>

        <!-- æ–‡ä»¶ç±»å‹åˆ†å¸ƒ -->
        <div class="stat-card">
          <h3>ğŸ“ æ–‡ä»¶ç±»å‹åˆ†å¸ƒ</h3>
          <div class="chart-container">
            <canvas ref="typeChart"></canvas>
          </div>
        </div>

        <!-- çŠ¶æ€ç»Ÿè®¡ -->
        <div class="stat-card">
          <h3>ğŸ” æ–‡ä»¶çŠ¶æ€</h3>
          <div class="overview-stats">
            <div class="overview-item" style="background: linear-gradient(135deg, #67c23a 0%, #85ce61 100%);">
              <div class="overview-number">{{ formatNumber(stats.status.normal) }}</div>
              <div class="overview-label">æ­£å¸¸</div>
            </div>
            <div class="overview-item" style="background: linear-gradient(135deg, #f56565 0%, #fc8181 100%);">
              <div class="overview-number">{{ formatNumber(stats.status.blocked) }}</div>
              <div class="overview-label">å·²å±è”½</div>
            </div>
            <div class="overview-item" style="background: linear-gradient(135deg, #409eff 0%, #66b1ff 100%);">
              <div class="overview-number">{{ formatNumber(stats.status.whitelisted) }}</div>
              <div class="overview-label">ç™½åå•</div>
            </div>
            <div class="overview-item" style="background: linear-gradient(135deg, #e6a23c 0%, #f0c78a 100%);">
              <div class="overview-number">{{ formatNumber(stats.status.liked) }}</div>
              <div class="overview-label">å·²æ”¶è—</div>
            </div>
          </div>
        </div>

        <!-- æœ€è¿‘ä¸Šä¼  -->
        <div class="stat-card">
          <h3>ğŸ•’ æœ€è¿‘ä¸Šä¼ </h3>
          <div class="recent-files">
            <div v-for="file in stats.recent" :key="file.name" class="file-item">
              <div class="file-info">
                <div class="file-name">{{ file.name }}</div>
                <div class="file-meta">
                  {{ formatDate(file.timestamp) }} â€¢ {{ formatSize(file.size) }} â€¢ {{ file.type }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" @click="loadStats" :disabled="loading">
      <el-icon :class="{ 'is-loading': loading }">
        <Refresh />
      </el-icon>
    </button>
  </div>

  <!-- Vue 3 å’Œ Element Plus -->
  <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.0/dist/index.iife.min.js"></script>

  <script>
    const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;
    const { ElMessage, ElMessageBox, ElNotification } = ElementPlus;

    const app = createApp({
      setup() {
        // å“åº”å¼æ•°æ®
        const loading = ref(true);
        const error = ref('');
        const stats = ref(null);
        const trendChart = ref(null);
        const typeChart = ref(null);

        let trendChartInstance = null;
        let typeChartInstance = null;

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        const loadStats = async () => {
          loading.value = true;
          error.value = '';

          try {
            const response = await fetch('./api/manage/stats', {
              method: 'GET',
              credentials: 'include'
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            stats.value = data;

            // ç­‰å¾… DOM æ›´æ–°ååˆ›å»ºå›¾è¡¨
            await nextTick();
            createCharts();

            ElMessage.success('ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ');
          } catch (err) {
            console.error('Failed to load stats:', err);
            error.value = `åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${err.message}`;
            ElMessage.error(error.value);
          } finally {
            loading.value = false;
          }
        };

        // åˆ›å»ºå›¾è¡¨
        const createCharts = () => {
          if (!stats.value) return;

          // é”€æ¯ç°æœ‰å›¾è¡¨
          if (trendChartInstance) {
            trendChartInstance.destroy();
          }
          if (typeChartInstance) {
            typeChartInstance.destroy();
          }

          // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
          if (trendChart.value) {
            const ctx = trendChart.value.getContext('2d');
            const dailyData = stats.value.trends.daily;

            trendChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: Object.keys(dailyData),
                datasets: [{
                  label: 'æ¯æ—¥ä¸Šä¼ é‡',
                  data: Object.values(dailyData),
                  borderColor: '#409eff',
                  backgroundColor: 'rgba(64, 158, 255, 0.1)',
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1
                    }
                  },
                  x: {
                    ticks: {
                      maxTicksLimit: 10
                    }
                  }
                }
              }
            });
          }

          // åˆ›å»ºæ–‡ä»¶ç±»å‹å›¾è¡¨
          if (typeChart.value) {
            const ctx = typeChart.value.getContext('2d');
            const typeData = stats.value.fileTypes.top.slice(0, 8);

            typeChartInstance = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: typeData.map(item => item.type.toUpperCase()),
                datasets: [{
                  data: typeData.map(item => item.count),
                  backgroundColor: [
                    '#409eff', '#67c23a', '#e6a23c', '#f56565',
                    '#909399', '#c45656', '#73767a', '#b88230'
                  ],
                  borderWidth: 0
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: {
                      padding: 20,
                      usePointStyle: true
                    }
                  }
                }
              }
            });
          }
        };

        // æ ¼å¼åŒ–æ•°å­—
        const formatNumber = (num) => {
          if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
          } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
          }
          return num.toString();
        };

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        const formatSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        };

        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (timestamp) => {
          if (!timestamp) return 'æœªçŸ¥';
          const date = new Date(timestamp);
          const now = new Date();
          const diff = now - date;

          if (diff < 60000) { // 1åˆ†é’Ÿå†…
            return 'åˆšåˆš';
          } else if (diff < 3600000) { // 1å°æ—¶å†…
            return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
          } else if (diff < 86400000) { // 1å¤©å†…
            return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
          } else if (diff < 604800000) { // 1å‘¨å†…
            return Math.floor(diff / 86400000) + 'å¤©å‰';
          } else {
            return date.toLocaleDateString('zh-CN');
          }
        };

        // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
        onMounted(() => {
          loadStats();

          // è®¾ç½®è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5åˆ†é’Ÿï¼‰
          setInterval(loadStats, 5 * 60 * 1000);
        });

        return {
          loading,
          error,
          stats,
          trendChart,
          typeChart,
          loadStats,
          formatNumber,
          formatSize,
          formatDate
        };
      }
    });

    // æ³¨å†Œ Element Plus å›¾æ ‡
    Object.keys(ElementPlusIconsVue).forEach(key => {
      app.component(key, ElementPlusIconsVue[key]);
    });

    app.use(ElementPlus);
    app.mount('#app');
  </script>
