<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegraph-Image | æ–‡ä»¶ä¸Šä¼ </title>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">

  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      padding: 16px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-links a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .upload-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(135deg, #409eff 0%, #67c23a 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }

    .card-header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
    }

    .card-header p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }

    .card-body {
      padding: 0;
    }

    .features {
      background: #f8f9fa;
      padding: 24px;
      border-top: 1px solid #eee;
    }

    .features h3 {
      margin: 0 0 16px 0;
      color: #303133;
      text-align: center;
    }

    .feature-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      max-width: 800px;
      margin: 0 auto;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .feature-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .feature-icon.drag {
      background: #e3f2fd;
      color: #1976d2;
    }

    .feature-icon.batch {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .feature-icon.progress {
      background: #e8f5e8;
      color: #388e3c;
    }

    .feature-icon.format {
      background: #fff3e0;
      color: #f57c00;
    }

    .feature-text {
      flex: 1;
    }

    .feature-title {
      font-weight: 600;
      color: #303133;
      margin: 0 0 4px 0;
    }

    .feature-desc {
      font-size: 14px;
      color: #606266;
      margin: 0;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 16px;
      }

      .nav-links {
        flex-wrap: wrap;
        justify-content: center;
      }

      .main-container {
        padding: 20px 16px;
      }

      .card-header h1 {
        font-size: 24px;
      }

      .feature-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="header-content">
        <a href="/" class="logo">Telegraph-Image</a>
        <nav class="nav-links">
          <a href="/">é¦–é¡µ</a>
          <a href="/upload.html" class="active">ä¸Šä¼ </a>
          <a href="/admin">ç®¡ç†</a>
          <a href="https://github.com/cf-pages/Telegraph-Image" target="_blank" rel="noopener">GitHub</a>
        </nav>
      </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-container">
      <div class="upload-card">
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <div class="card-header">
          <h1>æ–‡ä»¶ä¸Šä¼ </h1>
          <p>å¿«é€Ÿã€å®‰å…¨ã€å…è´¹çš„å›¾ç‰‡æ‰˜ç®¡æœåŠ¡</p>
        </div>

        <!-- ä¸Šä¼ ç»„ä»¶ -->
        <div class="card-body">
          <drag-upload />
        </div>

        <!-- åŠŸèƒ½ç‰¹æ€§ -->
        <div class="features">
          <h3>åŠŸèƒ½ç‰¹æ€§</h3>
          <div class="feature-list">
            <div class="feature-item">
              <div class="feature-icon drag">ğŸ“</div>
              <div class="feature-text">
                <div class="feature-title">æ‹–æ‹½ä¸Šä¼ </div>
                <div class="feature-desc">æ”¯æŒæ‹–æ‹½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°é¡µé¢ç›´æ¥ä¸Šä¼ </div>
              </div>
            </div>
            <div class="feature-item">
              <div class="feature-icon batch">âš¡</div>
              <div class="feature-text">
                <div class="feature-title">æ‰¹é‡å¤„ç†</div>
                <div class="feature-desc">ä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ‰¹é‡ä¸Šä¼ æ›´é«˜æ•ˆ</div>
              </div>
            </div>
            <div class="feature-item">
              <div class="feature-icon progress">ğŸ“Š</div>
              <div class="feature-text">
                <div class="feature-title">å®æ—¶è¿›åº¦</div>
                <div class="feature-desc">å®æ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦å’ŒçŠ¶æ€åé¦ˆ</div>
              </div>
            </div>
            <div class="feature-item">
              <div class="feature-icon format">ğŸ–¼ï¸</div>
              <div class="feature-text">
                <div class="feature-title">å¤šæ ¼å¼æ”¯æŒ</div>
                <div class="feature-desc">æ”¯æŒ JPGã€PNGã€GIFã€WebP ç­‰ä¸»æµæ ¼å¼</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Vue 3 å’Œ Element Plus -->
  <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.0/dist/index.iife.min.js"></script>

  <script>
    const { createApp } = Vue;
    const { ElMessage, ElNotification, ElProgress, ElButton, ElIcon } = ElementPlus;

    // æ‹–æ‹½ä¸Šä¼ ç»„ä»¶
    const DragUpload = {
      template: `
        <div class="drag-upload-container">
          <!-- æ‹–æ‹½åŒºåŸŸ -->
          <div
            ref="dropZone"
            class="drop-zone"
            :class="{
              'drag-over': isDragOver,
              'uploading': isUploading
            }"
            @drop="handleDrop"
            @dragover="handleDragOver"
            @dragenter="handleDragEnter"
            @dragleave="handleDragLeave"
            @click="triggerFileInput"
          >
            <div class="drop-zone-content">
              <el-icon class="upload-icon" :size="48">
                <component :is="'Upload'" />
              </el-icon>
              <div class="upload-text">
                <p class="primary-text">
                  {{ isDragOver ? 'é‡Šæ”¾æ–‡ä»¶å¼€å§‹ä¸Šä¼ ' : 'æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ' }}
                </p>
                <p class="secondary-text">
                  æˆ– <span class="click-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                </p>
                <p class="hint-text">
                  æ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼ï¼Œå•æ–‡ä»¶æœ€å¤§ 20MB
                </p>
              </div>
            </div>

            <!-- ä¸Šä¼ è¿›åº¦è¦†ç›–å±‚ -->
            <div v-if="isUploading" class="upload-overlay">
              <el-progress
                :percentage="uploadProgress"
                :stroke-width="6"
                status="success"
              />
              <p class="upload-status">{{ uploadStatusText }}</p>
            </div>
          </div>

          <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
          <input
            ref="fileInput"
            type="file"
            multiple
            accept="image/*"
            style="display: none"
            @change="handleFileSelect"
          />

          <!-- æ–‡ä»¶åˆ—è¡¨ -->
          <div v-if="fileList.length > 0" class="file-list">
            <h4>ä¸Šä¼ é˜Ÿåˆ— ({{ fileList.length }} ä¸ªæ–‡ä»¶)</h4>
            <div class="file-items">
              <div
                v-for="(file, index) in fileList"
                :key="file.uid"
                class="file-item"
                :class="file.status"
              >
                <div class="file-info">
                  <el-icon class="file-icon">
                    <component :is="file.type.startsWith('image/') ? 'Picture' : 'Document'" />
                  </el-icon>
                  <div class="file-details">
                    <span class="file-name">{{ file.name }}</span>
                    <span class="file-size">{{ formatFileSize(file.size) }}</span>
                  </div>
                </div>

                <div class="file-actions">
                  <el-progress
                    v-if="file.status === 'uploading'"
                    :percentage="file.progress"
                    :stroke-width="4"
                    :show-text="false"
                  />
                  <el-icon
                    v-else-if="file.status === 'success'"
                    class="success-icon"
                    color="#67c23a"
                  >
                    <component :is="'Check'" />
                  </el-icon>
                  <el-icon
                    v-else-if="file.status === 'error'"
                    class="error-icon"
                    color="#f56c6c"
                  >
                    <component :is="'Close'" />
                  </el-icon>
                  <el-button
                    v-if="file.status !== 'uploading'"
                    type="text"
                    size="small"
                    @click="removeFile(index)"
                  >
                    ç§»é™¤
                  </el-button>
                </div>
              </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="batch-actions">
              <el-button
                type="primary"
                :disabled="isUploading || !hasReadyFiles"
                @click="startBatchUpload"
              >
                å¼€å§‹ä¸Šä¼  ({{ readyFilesCount }})
              </el-button>
              <el-button
                :disabled="isUploading"
                @click="clearAll"
              >
                æ¸…ç©ºåˆ—è¡¨
              </el-button>
            </div>
          </div>

          <!-- ä¸Šä¼ ç»“æœ -->
          <div v-if="uploadResults.length > 0" class="upload-results">
            <h4>ä¸Šä¼ ç»“æœ</h4>
            <div class="result-items">
              <div
                v-for="result in uploadResults"
                :key="result.uid"
                class="result-item"
                :class="result.success ? 'success' : 'error'"
              >
                <div class="result-info">
                  <span class="result-name">{{ result.name }}</span>
                  <span v-if="result.success" class="result-url">
                    {{ result.url }}
                  </span>
                  <span v-else class="result-error">
                    {{ result.error }}
                  </span>
                </div>
                <div class="result-actions">
                  <el-button
                    v-if="result.success"
                    type="text"
                    size="small"
                    @click="copyUrl(result.url)"
                  >
                    å¤åˆ¶é“¾æ¥
                  </el-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,
      setup() {
        const { ref, computed, onMounted, onUnmounted } = Vue;

        // å“åº”å¼æ•°æ®
        const dropZone = ref(null);
        const fileInput = ref(null);
        const isDragOver = ref(false);
        const isUploading = ref(false);
        const uploadProgress = ref(0);
        const uploadStatusText = ref('');
        const fileList = ref([]);
        const uploadResults = ref([]);

        // è®¡ç®—å±æ€§
        const hasReadyFiles = computed(() =>
          fileList.value.some(file => file.status === 'ready')
        );

        const readyFilesCount = computed(() =>
          fileList.value.filter(file => file.status === 'ready').length
        );

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        const handleDragEnter = (e) => {
          e.preventDefault();
          isDragOver.value = true;
        };

        const handleDragOver = (e) => {
          e.preventDefault();
          isDragOver.value = true;
        };

        const handleDragLeave = (e) => {
          e.preventDefault();
          if (!dropZone.value.contains(e.relatedTarget)) {
            isDragOver.value = false;
          }
        };

        const handleDrop = (e) => {
          e.preventDefault();
          isDragOver.value = false;

          const files = Array.from(e.dataTransfer.files);
          processFiles(files);
        };

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        const triggerFileInput = () => {
          if (!isUploading.value) {
            fileInput.value.click();
          }
        };

        const handleFileSelect = (e) => {
          const files = Array.from(e.target.files);
          processFiles(files);
          e.target.value = '';
        };

        // æ–‡ä»¶å¤„ç†
        const processFiles = (files) => {
          const validFiles = files.filter(file => {
            if (!file.type.startsWith('image/')) {
              ElMessage.warning(\`\${file.name} ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶\`);
              return false;
            }

            if (file.size > 20 * 1024 * 1024) {
              ElMessage.warning(\`\${file.name} æ–‡ä»¶å¤§å°è¶…è¿‡ 20MB\`);
              return false;
            }

            return true;
          });

          validFiles.forEach(file => {
            const fileItem = {
              uid: Date.now() + Math.random(),
              name: file.name,
              size: file.size,
              type: file.type,
              file: file,
              status: 'ready',
              progress: 0
            };
            fileList.value.push(fileItem);
          });

          if (validFiles.length > 0) {
            ElMessage.success(\`å·²æ·»åŠ  \${validFiles.length} ä¸ªæ–‡ä»¶åˆ°ä¸Šä¼ é˜Ÿåˆ—\`);
          }
        };

        // æ–‡ä»¶ä¸Šä¼ 
        const startBatchUpload = async () => {
          const readyFiles = fileList.value.filter(file => file.status === 'ready');
          if (readyFiles.length === 0) return;

          isUploading.value = true;
          uploadProgress.value = 0;
          uploadStatusText.value = 'å‡†å¤‡ä¸Šä¼ ...';

          let completedCount = 0;
          const totalCount = readyFiles.length;

          for (const fileItem of readyFiles) {
            try {
              fileItem.status = 'uploading';
              uploadStatusText.value = \`æ­£åœ¨ä¸Šä¼  \${fileItem.name}...\`;

              const result = await uploadSingleFile(fileItem);

              fileItem.status = 'success';
              fileItem.progress = 100;

              uploadResults.value.push({
                uid: fileItem.uid,
                name: fileItem.name,
                success: true,
                url: result.url
              });

              completedCount++;
              uploadProgress.value = Math.round((completedCount / totalCount) * 100);

            } catch (error) {
              fileItem.status = 'error';
              uploadResults.value.push({
                uid: fileItem.uid,
                name: fileItem.name,
                success: false,
                error: error.message
              });

              completedCount++;
              uploadProgress.value = Math.round((completedCount / totalCount) * 100);
            }
          }

          isUploading.value = false;
          uploadStatusText.value = 'ä¸Šä¼ å®Œæˆ';

          ElNotification({
            title: 'ä¸Šä¼ å®Œæˆ',
            message: \`æˆåŠŸä¸Šä¼  \${uploadResults.value.filter(r => r.success).length} ä¸ªæ–‡ä»¶\`,
            type: 'success'
          });
        };

        // å•æ–‡ä»¶ä¸Šä¼ 
        const uploadSingleFile = async (fileItem) => {
          const formData = new FormData();
          formData.append('file', fileItem.file);

          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
              if (e.lengthComputable) {
                fileItem.progress = Math.round((e.loaded / e.total) * 100);
              }
            });

            xhr.addEventListener('load', () => {
              if (xhr.status === 200) {
                try {
                  const response = JSON.parse(xhr.responseText);
                  resolve(response);
                } catch (e) {
                  reject(new Error('å“åº”æ ¼å¼é”™è¯¯'));
                }
              } else {
                reject(new Error(\`ä¸Šä¼ å¤±è´¥: \${xhr.status}\`));
              }
            });

            xhr.addEventListener('error', () => {
              reject(new Error('ç½‘ç»œé”™è¯¯'));
            });

            xhr.open('POST', '/upload');
            xhr.send(formData);
          });
        };

        // å·¥å…·å‡½æ•°
        const formatFileSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const removeFile = (index) => {
          fileList.value.splice(index, 1);
        };

        const clearAll = () => {
          fileList.value = [];
          uploadResults.value = [];
        };

        const copyUrl = async (url) => {
          try {
            await navigator.clipboard.writeText(url);
            ElMessage.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          } catch (e) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            ElMessage.success('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          }
        };

        // ç”Ÿå‘½å‘¨æœŸ
        onMounted(() => {
          document.addEventListener('dragover', preventDefault);
          document.addEventListener('drop', preventDefault);
        });

        onUnmounted(() => {
          document.removeEventListener('dragover', preventDefault);
          document.removeEventListener('drop', preventDefault);
        });

        const preventDefault = (e) => {
          e.preventDefault();
        };

        return {
          dropZone,
          fileInput,
          isDragOver,
          isUploading,
          uploadProgress,
          uploadStatusText,
          fileList,
          uploadResults,
          hasReadyFiles,
          readyFilesCount,
          handleDragEnter,
          handleDragOver,
          handleDragLeave,
          handleDrop,
          triggerFileInput,
          handleFileSelect,
          startBatchUpload,
          formatFileSize,
          removeFile,
          clearAll,
          copyUrl
        };
      }
    };

    // åˆ›å»ºåº”ç”¨
    const app = createApp({
      components: {
        DragUpload
      }
    });

    // æ³¨å†Œ Element Plus å›¾æ ‡
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(key, component);
    }

    app.use(ElementPlus);
    app.mount('#app');
  </script>

  <style>
    .drag-upload-container {
      padding: 24px;
    }

    .drop-zone {
      border: 2px dashed #d9d9d9;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .drop-zone:hover {
      border-color: #409eff;
      background-color: #f5f7fa;
    }

    .drop-zone.drag-over {
      border-color: #67c23a;
      background-color: #f0f9ff;
      transform: scale(1.02);
    }

    .drop-zone.uploading {
      pointer-events: none;
    }

    .drop-zone-content {
      z-index: 1;
    }

    .upload-icon {
      color: #c0c4cc;
      margin-bottom: 16px;
    }

    .drag-over .upload-icon {
      color: #67c23a;
    }

    .upload-text .primary-text {
      font-size: 16px;
      color: #303133;
      margin: 0 0 8px 0;
    }

    .upload-text .secondary-text {
      font-size: 14px;
      color: #606266;
      margin: 0 0 8px 0;
    }

    .upload-text .click-text {
      color: #409eff;
      text-decoration: underline;
    }

    .upload-text .hint-text {
      font-size: 12px;
      color: #909399;
      margin: 0;
    }

    .upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .upload-status {
      margin-top: 16px;
      color: #606266;
      font-size: 14px;
    }

    .file-list {
      margin-top: 24px;
    }

    .file-list h4 {
      margin: 0 0 16px 0;
      color: #303133;
    }

    .file-items {
      border: 1px solid #ebeef5;
      border-radius: 4px;
      overflow: hidden;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #ebeef5;
      transition: background-color 0.3s;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-item:hover {
      background-color: #f5f7fa;
    }

    .file-item.uploading {
      background-color: #ecf5ff;
    }

    .file-item.success {
      background-color: #f0f9ff;
    }

    .file-item.error {
      background-color: #fef0f0;
    }

    .file-info {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .file-icon {
      margin-right: 12px;
      color: #909399;
    }

    .file-details {
      display: flex;
      flex-direction: column;
    }

    .file-name {
      font-size: 14px;
      color: #303133;
      margin-bottom: 4px;
    }

    .file-size {
      font-size: 12px;
      color: #909399;
    }

    .file-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .batch-actions {
      margin-top: 16px;
      text-align: center;
    }

    .batch-actions .el-button {
      margin: 0 8px;
    }

    .upload-results {
      margin-top: 24px;
    }

    .upload-results h4 {
      margin: 0 0 16px 0;
      color: #303133;
    }

    .result-items {
      border: 1px solid #ebeef5;
      border-radius: 4px;
      overflow: hidden;
    }

    .result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #ebeef5;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item.success {
      background-color: #f0f9ff;
    }

    .result-item.error {
      background-color: #fef0f0;
    }

    .result-info {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .result-name {
      font-size: 14px;
      color: #303133;
      margin-bottom: 4px;
    }

    .result-url {
      font-size: 12px;
      color: #67c23a;
      word-break: break-all;
    }

    .result-error {
      font-size: 12px;
      color: #f56c6c;
    }

    .result-actions {
      margin-left: 16px;
    }
  </style>
</body>
</html>