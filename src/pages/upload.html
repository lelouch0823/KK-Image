<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegraph-Image | æ–‡ä»¶ä¸Šä¼ </title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#409eff',
            secondary: '#67c23a',
            danger: '#f56c6c',
          },
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">

  <style>
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body class="gradient-bg min-h-screen font-sans text-gray-700">
  <div id="app" v-cloak>
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/10 backdrop-blur-md border-b border-white/10 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <a href="/" class="text-xl font-bold tracking-tight hover:opacity-90 transition-opacity">Telegraph-Image</a>
        <nav class="flex gap-6 text-sm font-medium">
          <a href="/" class="hover:text-white/80 transition-colors">é¦–é¡µ</a>
          <a href="/upload.html" class="text-white bg-white/20 px-3 py-1 rounded-full">ä¸Šä¼ </a>
          <a href="/admin" class="hover:text-white/80 transition-colors">ç®¡ç†</a>
          <a href="https://github.com/cf-pages/Telegraph-Image" target="_blank" rel="noopener"
            class="hover:text-white/80 transition-colors">GitHub</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="pt-28 pb-12 px-4 sm:px-6 lg:px-8 max-w-4xl mx-auto">
      <div class="glass-card rounded-2xl overflow-hidden">
        <!-- Card Header -->
        <div class="bg-gradient-to-r from-blue-500 to-green-500 p-8 text-center text-white">
          <h1 class="text-3xl font-bold mb-2">æ–‡ä»¶ä¸Šä¼ </h1>
          <p class="text-blue-50 opacity-90">å¿«é€Ÿã€å®‰å…¨ã€å…è´¹çš„å›¾ç‰‡æ‰˜ç®¡æœåŠ¡</p>
        </div>

        <!-- Upload Component Area -->
        <div class="p-8">
          <drag-upload />
        </div>

        <!-- Features Grid -->
        <div class="bg-gray-50/80 border-t border-gray-100 p-8">
          <h3 class="text-center text-gray-800 font-semibold mb-6">æ ¸å¿ƒç‰¹æ€§</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
            <!-- Feature 1 -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg">ğŸ“
              </div>
              <div>
                <div class="font-semibold text-gray-900">æ‹–æ‹½ä¸Šä¼ </div>
                <div class="text-xs text-gray-500">æ”¯æŒç›´æ¥æ‹–æ‹½æ–‡ä»¶ä¸Šä¼ </div>
              </div>
            </div>
            <!-- Feature 2 -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <div
                class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg">âš¡
              </div>
              <div>
                <div class="font-semibold text-gray-900">æ‰¹é‡å¤„ç†</div>
                <div class="text-xs text-gray-500">é«˜æ•ˆçš„å¤šæ–‡ä»¶å¹¶è¡Œä¸Šä¼ </div>
              </div>
            </div>
            <!-- Feature 3 -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg">
                ğŸ“Š</div>
              <div>
                <div class="font-semibold text-gray-900">å®æ—¶è¿›åº¦</div>
                <div class="text-xs text-gray-500">ç›´è§‚çš„ä¸Šä¼ çŠ¶æ€åé¦ˆ</div>
              </div>
            </div>
            <!-- Feature 4 -->
            <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
              <div
                class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-lg">
                ğŸ–¼ï¸</div>
              <div>
                <div class="font-semibold text-gray-900">å¤šæ ¼å¼æ”¯æŒ</div>
                <div class="text-xs text-gray-500">JPG, PNG, GIF, WebP</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Vue 3 & Element Plus -->
  <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.0/dist/index.iife.min.js"></script>

  <script>
    const { createApp, ref, computed, onMounted, onUnmounted } = Vue;
    const { ElMessage, ElNotification } = ElementPlus;

    const DragUpload = {
      template: `
        <div class="w-full">
          <!-- Drop Zone -->
          <div
            ref="dropZone"
            class="relative border-2 border-dashed rounded-xl p-10 text-center cursor-pointer transition-all duration-300 flex flex-col items-center justify-center min-h-[240px] group"
            :class="[
              isDragOver ? 'border-secondary bg-green-50 scale-[1.01]' : 'border-gray-300 hover:border-primary hover:bg-blue-50/50',
              isUploading ? 'opacity-50 pointer-events-none' : ''
            ]"
            @drop="handleDrop"
            @dragover="handleDragOver"
            @dragenter="handleDragEnter"
            @dragleave="handleDragLeave"
            @click="triggerFileInput"
          >
            <div class="z-10 flex flex-col items-center">
              <el-icon class="text-5xl mb-4 transition-colors duration-300" :class="isDragOver ? 'text-secondary' : 'text-gray-300 group-hover:text-primary'">
                <component :is="'Upload'" />
              </el-icon>
              
              <div class="text-base text-gray-700 font-medium mb-2">
                 {{ isDragOver ? 'é‡Šæ”¾æ–‡ä»¶å·²å¼€å§‹ä¸Šä¼ ' : 'ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„' }}
              </div>
              <div class="text-xs text-gray-400">
                 æ”¯æŒå›¾ç‰‡æ ¼å¼ï¼Œæœ€å¤§ 20MB
              </div>
            </div>

            <!-- Upload Overlay -->
            <div v-if="isUploading" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-20 flex flex-col items-center justify-center rounded-xl">
               <el-progress type="dashboard" :percentage="uploadProgress" :status="uploadStatus" :stroke-width="8" />
               <p class="mt-4 text-sm font-medium text-gray-600 animate-pulse">{{ uploadStatusText }}</p>
            </div>
          </div>

          <!-- Hidden Input -->
          <input ref="fileInput" type="file" multiple accept="image/*" class="hidden" @change="handleFileSelect" />

          <!-- File List -->
          <div v-if="fileList.length > 0" class="mt-8 space-y-4">
             <div class="flex items-center justify-between">
                <h4 class="font-semibold text-gray-800">ä¸Šä¼ åˆ—è¡¨ ({{ fileList.length }})</h4>
                <div class="flex gap-2">
                   <el-button type="primary" size="small" :disabled="isUploading || !hasReadyFiles" @click="startBatchUpload">
                     å¼€å§‹ä¸Šä¼  ({{ readyFilesCount }})
                   </el-button>
                   <el-button size="small" @click="clearAll" :disabled="isUploading">æ¸…ç©º</el-button>
                </div>
             </div>

             <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                <div 
                  v-for="(file, index) in fileList" 
                  :key="file.uid"
                  class="flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-lg shadow-sm transition-all hover:shadow-md"
                >
                   <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 text-gray-500">
                      <el-icon size="20"><Picture /></el-icon>
                   </div>
                   
                   <div class="flex-1 min-w-0">
                      <div class="truncate text-sm font-medium text-gray-700" :title="file.name">{{ file.name }}</div>
                      <div class="text-xs text-gray-400 mt-0.5">{{ formatFileSize(file.size) }}</div>
                   </div>

                   <!-- Status & Actions -->
                   <div class="flex items-center gap-2 flex-shrink-0">
                      <div v-if="file.status === 'uploading'" class="w-24">
                         <el-progress :percentage="file.progress" :show-text="false" :stroke-width="4" />
                      </div>
                      <el-icon v-else-if="file.status === 'success'" class="text-green-500 text-lg"><Check /></el-icon>
                      <el-icon v-else-if="file.status === 'error'" class="text-red-500 text-lg"><Close /></el-icon>
                      
                      <button 
                        v-if="file.status !== 'uploading'"
                        @click="removeFile(index)"
                        class="p-1 text-gray-400 hover:text-red-500 rounded-full hover:bg-gray-100 transition-colors"
                      >
                         <el-icon><Delete /></el-icon>
                      </button>
                   </div>
                </div>
             </div>
          </div>

          <!-- Results -->
          <div v-if="uploadResults.length > 0" class="mt-8">
             <h4 class="font-semibold text-gray-800 mb-4">ä¸Šä¼ ç»“æœ</h4>
             <div class="grid grid-cols-1 gap-3">
                <div 
                   v-for="result in uploadResults" 
                   :key="result.uid"
                   class="flex items-center justify-between p-3 rounded-lg border text-sm"
                   :class="result.success ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'"
                >
                   <div class="flex items-center gap-2 truncate">
                      <el-icon :class="result.success ? 'text-green-500' : 'text-red-500'">
                         <component :is="result.success ? 'SuccessFilled' : 'CircleCloseFilled'" />
                      </el-icon>
                      <span class="truncate font-medium" :class="result.success ? 'text-green-800' : 'text-red-800'">
                         {{ result.name }}
                      </span>
                   </div>
                   
                   <el-button 
                     v-if="result.success" 
                     type="success" 
                     link 
                     size="small" 
                     @click="copyUrl(result.url)"
                   >
                     å¤åˆ¶é“¾æ¥
                   </el-button>
                   <span v-else class="text-red-500 text-xs">{{ result.error }}</span>
                </div>
             </div>
          </div>
        </div>
      `,
      setup() {
        const dropZone = ref(null);
        const fileInput = ref(null);
        const isDragOver = ref(false);
        const isUploading = ref(false);
        const uploadProgress = ref(0);
        const uploadStatusText = ref('');
        const fileList = ref([]);
        const uploadResults = ref([]);
        const uploadStatus = ref(''); // 'success' | 'exception' | 'warning'

        const hasReadyFiles = computed(() => fileList.value.some(file => file.status === 'ready'));
        const readyFilesCount = computed(() => fileList.value.filter(file => file.status === 'ready').length);

        const handleDragEnter = (e) => { e.preventDefault(); isDragOver.value = true; };
        const handleDragOver = (e) => { e.preventDefault(); isDragOver.value = true; };
        const handleDragLeave = (e) => {
          e.preventDefault();
          if (dropZone.value && !dropZone.value.contains(e.relatedTarget)) isDragOver.value = false;
        };

        const handleDrop = (e) => {
          e.preventDefault();
          isDragOver.value = false;
          processFiles(Array.from(e.dataTransfer.files));
        };

        const triggerFileInput = () => { if (!isUploading.value) fileInput.value.click(); };
        const handleFileSelect = (e) => { processFiles(Array.from(e.target.files)); e.target.value = ''; };

        const processFiles = (files) => {
          const validFiles = files.filter(file => {
            if (!file.type.startsWith('image/')) { ElMessage.warning(`${file.name} ä¸æ˜¯å›¾ç‰‡`); return false; }
            if (file.size > 20 * 1024 * 1024) { ElMessage.warning(`${file.name} è¶…è¿‡ 20MB`); return false; }
            return true;
          });

          validFiles.forEach(file => {
            fileList.value.push({
              uid: Date.now() + Math.random(),
              name: file.name,
              size: file.size,
              type: file.type,
              file: file,
              status: 'ready',
              progress: 0
            });
          });

          if (validFiles.length) ElMessage.success(`æ·»åŠ  ${validFiles.length} ä¸ªæ–‡ä»¶`);
        };

        const startBatchUpload = async () => {
          const readyFiles = fileList.value.filter(f => f.status === 'ready');
          if (!readyFiles.length) return;

          isUploading.value = true;
          uploadProgress.value = 0;
          uploadStatusText.value = 'å‡†å¤‡ä¸Šä¼ ...';
          uploadStatus.value = '';

          let completed = 0;
          const total = readyFiles.length;

          for (const item of readyFiles) {
            try {
              item.status = 'uploading';
              uploadStatusText.value = `æ­£åœ¨ä¸Šä¼  ${item.name}...`;

              const result = await uploadSingleFile(item.file, (progress) => {
                item.progress = progress;
              });

              item.status = 'success';
              item.progress = 100;
              uploadResults.value.push({ uid: item.uid, name: item.name, success: true, url: result.url });

            } catch (err) {
              item.status = 'error';
              uploadResults.value.push({ uid: item.uid, name: item.name, success: false, error: err.message });
            }

            completed++;
            uploadProgress.value = Math.round((completed / total) * 100);
          }

          isUploading.value = false;
          uploadStatusText.value = 'ä¸Šä¼ ç»“æŸ';
          ElNotification({ title: 'ä»»åŠ¡å®Œæˆ', message: `æˆåŠŸä¸Šä¼  ${uploadResults.value.filter(r => r.success).length} ä¸ªæ–‡ä»¶`, type: 'success' });
        };

        const uploadSingleFile = (file, onProgress) => {
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const formData = new FormData();
            formData.append('file', file);

            xhr.upload.onprogress = (e) => { if (e.lengthComputable) onProgress(Math.round((e.loaded / e.total) * 100)); };
            xhr.onload = () => {
              if (xhr.status === 200) {
                try { resolve(JSON.parse(xhr.responseText)); } catch { reject(new Error('Format Error')); }
              } else { reject(new Error(`HTTP ${xhr.status}`)); }
            };
            xhr.onerror = () => reject(new Error('Network Error'));
            xhr.open('POST', '/upload');
            xhr.send(formData);
          });
        };

        const copyUrl = async (url) => {
          try { await navigator.clipboard.writeText(url); ElMessage.success('å·²å¤åˆ¶'); }
          catch { ElMessage.error('å¤åˆ¶å¤±è´¥'); }
        };

        // Util wrapper for template access
        const removeFile = (i) => fileList.value.splice(i, 1);
        const clearAll = () => { fileList.value = []; uploadResults.value = []; };
        const formatFileSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        onMounted(() => {
          document.addEventListener('dragover', (e) => e.preventDefault());
          document.addEventListener('drop', (e) => e.preventDefault());
        });

        return {
          dropZone, fileInput, isDragOver, isUploading, uploadProgress, uploadStatusText, uploadStatus,
          fileList, uploadResults, hasReadyFiles, readyFilesCount,
          handleDragEnter, handleDragOver, handleDragLeave, handleDrop, triggerFileInput, handleFileSelect,
          startBatchUpload, removeFile, clearAll, copyUrl, formatFileSize
        };
      }
    };

    const app = createApp({ components: { DragUpload } });
    for (const [key, comp] of Object.entries(ElementPlusIconsVue)) app.component(key, comp);
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>

</html>