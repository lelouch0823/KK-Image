<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImgTC | Admin Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#409eff',
            secondary: '#67c23a',
            danger: '#f56c6c',
          },
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">

  <!-- Sentry -->
  <script src="https://js.sentry-cdn.com/219f636ac7bde5edab2c3e16885cb535.min.js" crossorigin="anonymous"></script>

  <style>
    /* ç»ç’ƒæ‹Ÿæ€ä¸ç»†èŠ‚å¾®è°ƒ */
    .glass-effect {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-gray-700 selection:bg-primary selection:text-white">
  <div id="app" v-cloak>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="fixed top-0 left-0 right-0 z-50 glass-effect shadow-sm h-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
        <!-- Logo & Title -->
        <div class="flex items-center gap-3 cursor-pointer group" @click="refreshDashboard">
          <div
            class="w-8 h-8 rounded-lg bg-gradient-to-tr from-primary to-blue-400 flex items-center justify-center text-white font-bold text-lg shadow-md group-hover:scale-105 transition-transform">
            TC
          </div>
          <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">
            Dashboard
          </span>
        </div>

        <!-- Desktop Nav Items -->
        <div class="hidden md:flex items-center space-x-1">
          <a href="/admin-stats.html"
            class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-primary hover:bg-blue-50 transition-colors flex items-center gap-2">
            <span>ğŸ“Š</span> ç»Ÿè®¡åˆ†æ
          </a>
          <a href="/admin.html"
            class="px-4 py-2 rounded-lg text-sm font-medium text-primary bg-blue-50 flex items-center gap-2">
            <span>ğŸ“‹</span> åˆ—è¡¨è§†å›¾
          </a>
          <a href="/upload.html"
            class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-primary hover:bg-blue-50 transition-colors flex items-center gap-2">
            <span>ğŸ“¤</span> æ‹–æ‹½ä¸Šä¼ 
          </a>
        </div>

        <!-- Right Side Actions -->
        <div class="flex items-center gap-4">
          <!-- Search -->
          <div class="hidden sm:block w-64">
            <el-input v-model="search" placeholder="æœç´¢æ–‡ä»¶..." clearable class="!w-full">
              <template #prefix>
                <el-icon>
                  <Search />
                </el-icon>
              </template>
            </el-input>
          </div>

          <!-- Upload Trigger -->
          <el-tooltip content="æ‰¹é‡ä¸Šä¼ " placement="bottom">
            <button @click="handleUpload"
              class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-gray-200 hover:border-primary hover:text-primary transition-all shadow-sm text-sm text-gray-600">
              <el-icon>
                <Upload />
              </el-icon>
              <span class="font-medium">{{ totalFiles }}</span>
            </button>
          </el-tooltip>

          <!-- Logout -->
          <el-tooltip content="é€€å‡ºç™»å½•" placement="bottom">
            <button @click="handleLogout"
              class="p-2 rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors">
              <el-icon size="18"><Switch-Button /></el-icon>
            </button>
          </el-tooltip>

          <!-- Hidden Upload Input -->
          <input type="file" ref="fileInputRef" style="display: none;" multiple @change="uploadFiles">
        </div>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">

      <!-- ç§»åŠ¨ç«¯æœç´¢æ  (ä»…å°å±æ˜¾ç¤º) -->
      <div class="md:hidden mb-6">
        <el-input v-model="search" placeholder="æœç´¢æ–‡ä»¶..." clearable class="!w-full">
          <template #prefix><el-icon>
              <Search />
            </el-icon></template>
        </el-input>
        <div class="flex justify-between mt-4 overflow-x-auto pb-2 gap-2">
          <a href="/admin-stats.html"
            class="flex-shrink-0 px-3 py-1.5 rounded-md text-xs font-medium bg-white border border-gray-200 text-gray-600">ğŸ“Š
            ç»Ÿè®¡</a>
          <a href="/upload.html"
            class="flex-shrink-0 px-3 py-1.5 rounded-md text-xs font-medium bg-white border border-gray-200 text-gray-600">ğŸ“¤
            ä¸Šä¼ </a>
          <a href="/admin.html"
            class="flex-shrink-0 px-3 py-1.5 rounded-md text-xs font-medium bg-blue-50 text-primary border border-blue-100">ğŸ“‹
            åˆ—è¡¨</a>
        </div>
      </div>

      <!-- Loading State -->
      <div v-if="loading" class="flex flex-col items-center justify-center py-20">
        <el-icon class="is-loading text-primary text-4xl mb-4">
          <Loading />
        </el-icon>
        <p class="text-gray-500 text-sm">æ­£åœ¨åŒæ­¥æ•°æ®...</p>
      </div>

      <!-- Empty State -->
      <div v-else-if="filteredData.length === 0"
        class="flex flex-col items-center justify-center py-20 bg-white rounded-2xl shadow-sm border border-gray-100">
        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
          <el-icon class="text-gray-300 text-3xl"><Folder-Opened /></el-icon>
        </div>
        <h3 class="text-lg font-medium text-gray-900">æš‚æ— æ–‡ä»¶</h3>
        <p class="text-gray-500 text-sm mt-1 mb-6">ä¸Šä¼ ä¸€äº›æ–‡ä»¶æ¥å¼€å§‹ä½¿ç”¨å§</p>
        <el-button type="primary" @click="handleUpload" round>
          <el-icon class="mr-2">
            <Upload />
          </el-icon> ä¸Šä¼ æ–‡ä»¶
        </el-button>
      </div>

      <!-- Grid Layout -->
      <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div v-for="item in paginatedData" :key="item.name"
          class="group relative bg-white rounded-xl overflow-hidden border border-gray-100 card-hover cursor-pointer"
          :class="{ 'ring-2 ring-primary ring-offset-2': item.selected }" @click="toggleSelection(item)">
          <!-- Select Checkbox Indicator -->
          <div class="absolute top-3 left-3 z-10 opacity-0 group-hover:opacity-100 transition-opacity"
            :class="{ '!opacity-100': item.selected }">
            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors"
              :class="item.selected ? 'bg-primary border-primary' : 'bg-white/90 border-gray-300 hover:border-primary'">
              <el-icon v-if="item.selected" class="text-white text-xs">
                <Check />
              </el-icon>
            </div>
          </div>

          <!-- Preview Area -->
          <div class="h-48 bg-gray-50 relative overflow-hidden group">
            <!-- Image -->
            <img v-if="isImage(item)" :src="getFileUrl(item)" :alt="item.metadata.fileName"
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
              @error="handleImageError" loading="lazy" />
            <!-- Non-Image Placeholder -->
            <div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-400">
              <el-icon class="text-5xl mb-2">
                <Document />
              </el-icon>
              <span class="text-xs uppercase font-medium tracking-wider">{{ getFileExtension(item.name) }}</span>
            </div>

            <!-- Hover Overlay -->
            <div
              class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 backdrop-blur-[2px]">
              <el-button type="primary" size="" circle @click.stop="copyUrl(item)">
                <el-icon><Copy-Document /></el-icon>
              </el-button>
              <el-button type="danger" size="" circle @click.stop="deleteFile(item)">
                <el-icon>
                  <Delete />
                </el-icon>
              </el-button>
            </div>
          </div>

          <!-- Info Area -->
          <div class="p-4">
            <div class="flex items-start justify-between mb-2">
              <h3 class="text-sm font-medium text-gray-900 truncate flex-1 pr-2" :title="item.metadata.fileName">
                {{ item.metadata.fileName }}
              </h3>
            </div>
            <div class="flex items-center justify-between text-xs text-gray-500">
              <span>{{ formatFileSize(item.metadata.fileSize) }}</span>
              <span>{{ formatDate(item.metadata.TimeStamp) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div v-if="filteredData.length > 0" class="mt-10 flex justify-center">
        <el-pagination v-model:current-page="currentPage" v-model:page-size="pageSize" :page-sizes="[12, 24, 48, 100]"
          :total="filteredData.length" layout="total, sizes, prev, pager, next, jumper" background />
      </div>
    </main>

    <!-- åº•éƒ¨æ‰¹é‡æ“ä½œæ  -->
    <transition enter-active-class="transform transition ease-out duration-300"
      enter-from-class="translate-y-full opacity-0" enter-to-class="translate-y-0 opacity-100"
      leave-active-class="transform transition ease-in duration-200" leave-from-class="translate-y-0 opacity-100"
      leave-to-class="translate-y-full opacity-0">
      <div v-if="selectedFiles.length > 0"
        class="fixed bottom-6 left-0 right-0 z-40 flex justify-center pointer-events-none">
        <div
          class="bg-white rounded-full shadow-xl border border-gray-100 px-6 py-3 flex items-center gap-4 pointer-events-auto">
          <span class="text-sm text-gray-600 font-medium">å·²é€‰æ‹© <span class="text-primary">{{ selectedFiles.length
              }}</span> é¡¹</span>
          <div class="h-4 w-px bg-gray-200"></div>
          <el-button type="danger" round size="small" @click="batchDelete">
            <el-icon class="mr-1">
              <Delete />
            </el-icon> æ‰¹é‡åˆ é™¤
          </el-button>
          <el-button round size="small" @click="clearSelection">å–æ¶ˆ</el-button>
        </div>
      </div>
    </transition>

    <!-- ä¸Šä¼ è¿›åº¦å¯¹è¯æ¡† -->
    <el-dialog v-model="uploadDialogVisible" title="æ‰¹é‡ä¸Šä¼ ä¸­" width="30%" class="!rounded-2xl"
      :close-on-click-modal="false">
      <div class="py-4">
        <el-progress :percentage="uploadProgress" :status="uploadStatus" :stroke-width="10" striped striped-flow
          class="mb-4" />
        <div class="flex justify-between text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg">
          <div class="flex flex-col items-center">
            <span class="text-lg font-bold text-green-500">{{ uploadCompleted }}</span>
            <span class="text-xs">æˆåŠŸ</span>
          </div>
          <div class="h-auto w-px bg-gray-200"></div>
          <div class="flex flex-col items-center">
            <span class="text-lg font-bold text-gray-700">{{ uploadTotal }}</span>
            <span class="text-xs">æ€»æ•°</span>
          </div>
          <div class="h-auto w-px bg-gray-200"></div>
          <div class="flex flex-col items-center">
            <span class="text-lg font-bold text-red-500">{{ uploadFailed }}</span>
            <span class="text-xs">å¤±è´¥</span>
          </div>
        </div>

        <div class="max-h-48 overflow-y-auto border border-gray-100 rounded-lg p-2 space-y-2 bg-gray-50/50">
          <div v-for="(log, index) in uploadLogs" :key="index" class="text-xs p-2 rounded flex items-start gap-2"
            :class="log.type === 'success' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'">
            <el-icon class="mt-0.5">
              <component :is="log.type === 'success' ? 'Check' : 'Close'" />
            </el-icon>
            <span class="break-all">{{ log.message }}</span>
          </div>
        </div>
      </div>
    </el-dialog>
  </div>

  <!-- Vue 3 å’Œ Element Plus JS -->
  <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.0/dist/index.iife.min.js"></script>

  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    const { ElMessage, ElMessageBox, ElNotification } = ElementPlus;

    const app = createApp({
      setup() {
        // --- State ---
        const loading = ref(false);
        const search = ref('');
        const currentPage = ref(1);
        const pageSize = ref(12); // Grid å¸ƒå±€ä¸‹ä½¿ç”¨ 12 (3x4, 4x3) æ›´æ•´é½
        const tableData = ref([]);
        const selectedFiles = ref([]);
        const fileInputRef = ref();

        // Upload State
        const uploadDialogVisible = ref(false);
        const uploadProgress = ref(0);
        const uploadStatus = ref('');
        const uploadCompleted = ref(0);
        const uploadTotal = ref(0);
        const uploadFailed = ref(0);
        const uploadLogs = ref([]);

        // Config
        const uploadConfig = reactive({
          maxSize: 20 * 1024 * 1024,
          maxConcurrent: 3
        });

        // --- Computed ---
        const totalFiles = computed(() => tableData.value.length);

        const filteredData = computed(() => {
          let data = tableData.value;
          if (search.value) {
            data = data.filter(item =>
              item.metadata.fileName.toLowerCase().includes(search.value.toLowerCase())
            );
          }
          // Sort by timestamp desc
          data = [...data].sort((a, b) => b.metadata.TimeStamp - a.metadata.TimeStamp);
          return data;
        });

        const paginatedData = computed(() => {
          const start = (currentPage.value - 1) * pageSize.value;
          const end = start + pageSize.value;
          return filteredData.value.slice(start, end);
        });

        // --- Helpers ---
        const getFileExtension = (filename) => filename.split('.').pop() || '';

        const isImage = (item) => {
          const ext = getFileExtension(item.name).toLowerCase();
          return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'ico'].includes(ext);
        };

        const getFileUrl = (item) => `${window.location.origin}/file/${item.name}`;

        const formatFileSize = (bytes) => {
          if (!bytes) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const formatDate = (timestamp) => new Date(timestamp).toLocaleString('zh-CN');

        // --- Core Methods ---
        const refreshDashboard = async () => {
          loading.value = true;
          try {
            const response = await fetch('./api/manage/list', {
              method: 'GET',
              credentials: 'include'
            });
            const result = await response.json();

            // å…¼å®¹æ€§é€‚é…
            const fileList = result.data || result.keys || (Array.isArray(result) ? result : []);

            tableData.value = fileList.map(file => ({
              ...file,
              selected: false,
              metadata: {
                ...file.metadata,
                liked: file.metadata?.liked ?? false,
                fileName: file.metadata?.fileName ?? file.name,
                fileSize: file.metadata?.fileSize ?? 0,
                TimeStamp: file.metadata?.TimeStamp ?? Date.now()
              }
            }));

            ElMessage.success({ message: 'æ•°æ®å·²åŒæ­¥', grouping: true });
          } catch (error) {
            // ä»… logï¼Œä¸å¼¹çª—æ‰“æ‰°ç”¨æˆ·ï¼ˆå¦‚æœåªæ˜¯ç½‘ç»œæ³¢åŠ¨ï¼‰
            console.error(error);
            tableData.value = []; // Clear on error
          } finally {
            loading.value = false;
          }
        };

        const handleUpload = () => fileInputRef.value?.click();

        const uploadFiles = async (event) => {
          const files = Array.from(event.target.files);
          if (files.length === 0) return;

          const validFiles = files.filter(file => {
            if (file.size > uploadConfig.maxSize) {
              ElMessage.error(`æ–‡ä»¶ ${file.name} è¶…è¿‡ 20MB é™åˆ¶`);
              return false;
            }
            return true;
          });

          if (validFiles.length === 0) return;

          // Reset UI
          uploadDialogVisible.value = true;
          uploadProgress.value = 0;
          uploadCompleted.value = 0;
          uploadTotal.value = validFiles.length;
          uploadFailed.value = 0;
          uploadLogs.value = [];
          uploadStatus.value = '';

          try {
            for (let i = 0; i < validFiles.length; i += uploadConfig.maxConcurrent) {
              const batch = validFiles.slice(i, i + uploadConfig.maxConcurrent);
              await Promise.all(
                batch.map(async (file) => {
                  try {
                    await uploadSingleFile(file);
                    uploadCompleted.value++;
                    uploadLogs.value.unshift({ type: 'success', message: `${file.name} ä¸Šä¼ æˆåŠŸ` });
                  } catch (error) {
                    uploadFailed.value++;
                    uploadLogs.value.unshift({ type: 'error', message: `${file.name} å¤±è´¥: ${error.message}` });
                  }
                  uploadProgress.value = Math.round(((uploadCompleted.value + uploadFailed.value) / uploadTotal.value) * 100);
                })
              );
            }

            uploadStatus.value = uploadFailed.value > 0 ? 'exception' : 'success';

            // å»¶è¿Ÿå…³é—­å¹¶åˆ·æ–°
            if (uploadFailed.value === 0) {
              setTimeout(() => { uploadDialogVisible.value = false; }, 1500);
            }
            await refreshDashboard();
          } finally {
            if (fileInputRef.value) fileInputRef.value.value = '';
          }
        };

        const uploadSingleFile = async (file) => {
          const formData = new FormData();
          formData.append('file', file);
          const response = await fetch('/upload', { method: 'POST', body: formData });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        };

        const toggleSelection = (item) => {
          item.selected = !item.selected;
          if (item.selected) {
            if (!selectedFiles.value.find(f => f.name === item.name)) selectedFiles.value.push(item);
          } else {
            const index = selectedFiles.value.findIndex(f => f.name === item.name);
            if (index > -1) selectedFiles.value.splice(index, 1);
          }
        };

        const clearSelection = () => {
          tableData.value.forEach(item => item.selected = false);
          selectedFiles.value = [];
        };

        const copyUrl = async (item) => {
          const url = getFileUrl(item);
          try {
            await navigator.clipboard.writeText(url);
            ElMessage.success('é“¾æ¥å·²å¤åˆ¶');
          } catch (error) {
            ElMessage.error('å¤åˆ¶å¤±è´¥');
          }
        };

        const deleteFile = async (item) => {
          try {
            await ElMessageBox.confirm(`ç¡®è®¤åˆ é™¤ "${item.metadata.fileName}"?`, 'åˆ é™¤ç¡®è®¤', {
              confirmButtonText: 'åˆ é™¤',
              cancelButtonText: 'å–æ¶ˆ',
              type: 'warning',
              confirmButtonClass: 'el-button--danger'
            });

            const response = await fetch(`./api/manage/delete/${item.name}`, { method: 'GET', credentials: 'include' });
            if (response.ok) {
              const index = tableData.value.findIndex(f => f.name === item.name);
              if (index > -1) tableData.value.splice(index, 1);
              ElMessage.success('å·²åˆ é™¤');
              // åŒæ—¶ä»é€‰ä¸­åˆ—è¡¨ä¸­ç§»é™¤å¦‚æœå­˜åœ¨
              const selIndex = selectedFiles.value.findIndex(f => f.name === item.name);
              if (selIndex > -1) selectedFiles.value.splice(selIndex, 1);
            } else {
              ElMessage.error('åˆ é™¤å¤±è´¥');
            }
          } catch { /* Cancelled */ }
        };

        const batchDelete = async () => {
          if (selectedFiles.value.length === 0) return;
          try {
            await ElMessageBox.confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${selectedFiles.value.length} ä¸ªæ–‡ä»¶?`, 'æ‰¹é‡åˆ é™¤', {
              confirmButtonText: 'æ‰¹é‡åˆ é™¤',
              cancelButtonText: 'å–æ¶ˆ',
              type: 'warning'
            });

            const deletePromises = selectedFiles.value.map(item =>
              fetch(`./api/manage/delete/${item.name}`, { method: 'GET', credentials: 'include' })
            );

            await Promise.all(deletePromises);

            // Optimistic UI update or refresh
            await refreshDashboard();
            clearSelection();
            ElMessage.success('æ‰¹é‡åˆ é™¤å®Œæˆ');
          } catch { /* Cancelled */ }
        };

        const handleImageError = (event) => {
          // Hide broken image, show placeholder
          event.target.style.display = 'none';
          event.target.parentElement.classList.add('flex', 'items-center', 'justify-center');
        };

        const handleLogout = async () => {
          try { await fetch('/api/manage/logout', { method: 'POST' }); }
          finally { window.location.href = '/login.html'; }
        };

        // --- Lifecycle ---
        onMounted(async () => {
          try {
            const response = await fetch('./api/manage/check', { method: 'GET', credentials: 'include' });
            if (!response.ok) { window.location.href = '/login.html'; return; }
          } catch {
            // Network fail
          }
          await refreshDashboard();
        });

        return {
          // Refs
          loading, search, currentPage, pageSize, tableData, selectedFiles, fileInputRef,
          uploadDialogVisible, uploadProgress, uploadStatus, uploadCompleted, uploadTotal, uploadFailed, uploadLogs,
          // Computed
          totalFiles, filteredData, paginatedData,
          // Methods
          isImage, getFileUrl, formatFileSize, formatDate, refreshDashboard,
          handleUpload, uploadFiles, toggleSelection, clearSelection, copyUrl, deleteFile, batchDelete,
          handleImageError, handleLogout, getFileExtension
        };
      }
    });

    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
      app.component(key, component);
    }
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>

</html>