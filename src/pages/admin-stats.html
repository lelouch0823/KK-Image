<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegraph-Image | ç»Ÿè®¡åˆ†æ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#409eff',
            secondary: '#67c23a',
            danger: '#f56c6c',
          },
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.0/dist/index.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: transform 0.2s;
    }

    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.2);
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-gray-700">
  <div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="sticky top-0 z-50 glass-effect border-b border-gray-100">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-500 text-white flex items-center justify-center font-bold shadow-sm">
            S
          </div>
          <span
            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">ç»Ÿè®¡åˆ†æ</span>
        </div>

        <nav class="flex gap-4 text-sm font-medium">
          <a href="/admin"
            class="px-3 py-1.5 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-primary transition-colors flex items-center gap-2">
            <span>ğŸ“‹</span> è¿”å›åˆ—è¡¨
          </a>
          <a href="/"
            class="px-3 py-1.5 rounded-lg text-gray-600 hover:bg-gray-100 hover:text-primary transition-colors flex items-center gap-2">
            <span>ğŸ </span>é¦–é¡µ
          </a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">

      <!-- Loading State -->
      <div v-if="loading" class="h-96 flex flex-col items-center justify-center">
        <el-icon class="is-loading text-4xl text-indigo-500 mb-4">
          <Loading />
        </el-icon>
        <span class="text-gray-500 font-medium">æ­£åœ¨åˆ†ææ•°æ®...</span>
      </div>

      <!-- Error State -->
      <div v-else-if="error" class="h-96 flex flex-col items-center justify-center text-center">
        <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-4">
          <el-icon class="text-red-500 text-2xl">
            <Warning />
          </el-icon>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">æ•°æ®åŠ è½½å¤±è´¥</h3>
        <p class="text-gray-500 mb-6">{{ error }}</p>
        <el-button type="primary" @click="loadStats">é‡æ–°åŠ è½½</el-button>
      </div>

      <!-- Content -->
      <div v-else-if="stats" class="space-y-6">
        <!-- Top Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div
            class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm flex flex-col justify-center items-center text-center group hover:border-blue-200 transition-colors">
            <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">æ€»æ–‡ä»¶æ•°</span>
            <span class="text-3xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{{
              formatNumber(stats.overview.totalFiles) }}</span>
          </div>
          <div
            class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm flex flex-col justify-center items-center text-center group hover:border-green-200 transition-colors">
            <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">ä»Šæ—¥ä¸Šä¼ </span>
            <span class="text-3xl font-bold text-gray-800 group-hover:text-green-600 transition-colors">{{
              formatNumber(stats.overview.todayUploads) }}</span>
          </div>
          <div
            class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm flex flex-col justify-center items-center text-center group hover:border-purple-200 transition-colors">
            <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">æœ¬å‘¨ä¸Šä¼ </span>
            <span class="text-3xl font-bold text-gray-800 group-hover:text-purple-600 transition-colors">{{
              formatNumber(stats.overview.weekUploads) }}</span>
          </div>
          <div
            class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm flex flex-col justify-center items-center text-center group hover:border-orange-200 transition-colors">
            <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">æ€»å­˜å‚¨é‡</span>
            <span class="text-3xl font-bold text-gray-800 group-hover:text-orange-600 transition-colors">{{
              formatSize(stats.overview.totalSize) }}</span>
          </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- è¶‹åŠ¿å›¾ (å ç”¨ 2/3) -->
          <div class="lg:col-span-2 stats-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
              <span class="w-1 h-6 bg-blue-500 rounded-full"></span>
              è¿‘30å¤©ä¸Šä¼ è¶‹åŠ¿
            </h3>
            <div class="relative h-72">
              <canvas ref="trendChart"></canvas>
            </div>
          </div>

          <!-- ç±»å‹åˆ†å¸ƒ (å ç”¨ 1/3) -->
          <div class="stats-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
              <span class="w-1 h-6 bg-green-500 rounded-full"></span>
              æ–‡ä»¶ç±»å‹
            </h3>
            <div class="relative h-72 flex items-center justify-center">
              <canvas ref="typeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Bottom Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- æ–‡ä»¶çŠ¶æ€ -->
          <div class="stats-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span class="w-1 h-6 bg-purple-500 rounded-full"></span>
              çŠ¶æ€æ¦‚è§ˆ
            </h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-4 rounded-xl border border-green-100/50">
                <span class="block text-green-600 text-sm font-medium mb-1">æ­£å¸¸çŠ¶æ€</span>
                <span class="text-2xl font-bold text-green-700">{{ formatNumber(stats.status.normal) }}</span>
              </div>
              <div class="bg-gradient-to-br from-red-50 to-rose-100 p-4 rounded-xl border border-red-100/50">
                <span class="block text-red-600 text-sm font-medium mb-1">å·²å±è”½</span>
                <span class="text-2xl font-bold text-red-700">{{ formatNumber(stats.status.blocked) }}</span>
              </div>
              <div class="bg-gradient-to-br from-blue-50 to-sky-100 p-4 rounded-xl border border-blue-100/50">
                <span class="block text-blue-600 text-sm font-medium mb-1">ç™½åå•</span>
                <span class="text-2xl font-bold text-blue-700">{{ formatNumber(stats.status.whitelisted) }}</span>
              </div>
              <div class="bg-gradient-to-br from-yellow-50 to-amber-100 p-4 rounded-xl border border-yellow-100/50">
                <span class="block text-amber-600 text-sm font-medium mb-1">å·²ç‚¹èµ</span>
                <span class="text-2xl font-bold text-amber-700">{{ formatNumber(stats.status.liked) }}</span>
              </div>
            </div>
          </div>

          <!-- æœ€è¿‘ä¸Šä¼ åˆ—è¡¨ -->
          <div class="stats-card p-6 flex flex-col h-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <span class="w-1 h-6 bg-orange-500 rounded-full"></span>
              æœ€è¿‘æ´»åŠ¨
            </h3>
            <div class="flex-1 overflow-y-auto custom-scrollbar max-h-[250px] pr-2">
              <div v-for="file in stats.recent" :key="file.name"
                class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 px-2 rounded-lg transition-colors">
                <div class="flex items-center gap-3 overflow-hidden">
                  <div
                    class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 text-xs font-bold uppercase shrink-0">
                    {{ file.type.split('/')[1] || 'FILE' }}
                  </div>
                  <div class="min-w-0">
                    <div class="text-sm font-medium text-gray-900 truncate max-w-[150px] sm:max-w-[200px]"
                      :title="file.name">{{ file.name }}</div>
                    <div class="text-xs text-gray-500">{{ formatDate(file.timestamp) }}</div>
                  </div>
                </div>
                <span
                  class="text-xs font-medium text-gray-400 bg-gray-100 px-2 py-1 rounded-full whitespace-nowrap ml-2">
                  {{ formatSize(file.size) }}
                </span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Floating Refresh Button -->
    <button @click="loadStats"
      class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-primary text-white shadow-lg shadow-blue-500/30 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-40"
      :class="{ 'animate-spin': loading }" :disabled="loading">
      <el-icon size="24">
        <Refresh />
      </el-icon>
    </button>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/vue@3.4.0/dist/vue.global.js"></script>
  <script src="https://unpkg.com/element-plus@2.4.0/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue@2.3.0/dist/index.iife.min.js"></script>

  <script>
    const { createApp, ref, nextTick, onMounted } = Vue;
    const { ElMessage } = ElementPlus;

    const app = createApp({
      setup() {
        // --- State ---
        const loading = ref(true);
        const error = ref('');
        const stats = ref(null);
        const trendChart = ref(null);
        const typeChart = ref(null);

        let trendChartInstance = null;
        let typeChartInstance = null;

        // --- Methods ---
        const formatNumber = (num) => {
          if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
          if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
          return num?.toString() || '0';
        };

        const formatSize = (bytes) => {
          if (!bytes) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        };

        const formatDate = (timestamp) => {
          if (!timestamp) return 'æœªçŸ¥';
          const date = new Date(timestamp);
          const diff = Date.now() - date.getTime();
          if (diff < 60000) return 'åˆšåˆš';
          if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
          if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
          return date.toLocaleDateString('zh-CN');
        };

        const createCharts = () => {
          if (!stats.value) return;

          // Destroy Old
          if (trendChartInstance) trendChartInstance.destroy();
          if (typeChartInstance) typeChartInstance.destroy();

          // New Trend Chart
          if (trendChart.value) {
            const ctx = trendChart.value.getContext('2d');
            const dailyData = stats.value.trends.daily;

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(64, 158, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(64, 158, 255, 0)');

            trendChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: Object.keys(dailyData),
                datasets: [{
                  label: 'æ¯æ—¥ä¸Šä¼ ',
                  data: Object.values(dailyData),
                  borderColor: '#409eff',
                  backgroundColor: gradient,
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                  pointHoverRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                  x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } },
                  y: { border: { dash: [4, 4] }, grid: { color: '#f3f4f6' }, beginAtZero: true }
                },
                interaction: { intersect: false, mode: 'index' }
              }
            });
          }

          // New Type Chart
          if (typeChart.value) {
            const ctx = typeChart.value.getContext('2d');
            const typeData = stats.value.fileTypes.top.slice(0, 6);

            typeChartInstance = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: typeData.map(i => i.type.toUpperCase()),
                datasets: [{
                  data: typeData.map(i => i.count),
                  backgroundColor: ['#409eff', '#67c23a', '#e6a23c', '#f56c6c', '#909399', '#8e44ad'],
                  borderWidth: 0,
                  hoverOffset: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                  legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                }
              }
            });
          }
        };

        const loadStats = async () => {
          loading.value = true;
          error.value = '';
          try {
            const response = await fetch('./api/manage/stats', { method: 'GET', credentials: 'include' });
            if (!response.ok) throw new Error('API Request Failed');

            stats.value = await response.json();
            await nextTick();
            createCharts();
            ElMessage.success('ç»Ÿè®¡åˆ·æ–°æˆåŠŸ');
          } catch (err) {
            console.error(err);
            // Verify if actually error or just empty
            // error.value = err.message; // Don't block UI if just generic error, rely on console
            // Mock data if fails for preview? No, keep real.
            if (!stats.value) error.value = "æ— æ³•åŠ è½½æ•°æ®";
          } finally {
            loading.value = false;
          }
        };

        onMounted(() => {
          loadStats();
          setInterval(loadStats, 300000); // 5 min refresh
        });

        return {
          loading, error, stats, trendChart, typeChart,
          formatNumber, formatSize, formatDate, loadStats
        };
      }
    });

    for (const [key, comp] of Object.entries(ElementPlusIconsVue)) app.component(key, comp);
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>

</html>